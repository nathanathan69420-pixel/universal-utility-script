local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

local Window = Rayfield:CreateWindow({
    Name = "Universal Utility Script",
    LoadingTitle = "This was made for educational purposes ;)",
    LoadingSubtitle = "Like and Subscribe",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "UniversalUtilityConfig",
        FileName = "Settings"
    }
})

local MovementTab = Window:CreateTab("Movement", 4483362458)
local VisualsTab = Window:CreateTab("Visuals", 4483362458)

-- WalkSpeed
local selectedSpeed = 16
local walkspeedEnabled = false
local originalWalkSpeed = nil

local function getHumanoid()
    if player.Character then
        return player.Character:FindFirstChildWhichIsA("Humanoid")
    end
end

RunService.Heartbeat:Connect(function()
    local humanoid = getHumanoid()
    if humanoid then
        if not originalWalkSpeed then originalWalkSpeed = humanoid.WalkSpeed end
        if walkspeedEnabled then
            humanoid.WalkSpeed = selectedSpeed
        else
            humanoid.WalkSpeed = originalWalkSpeed
        end
    end
end)

MovementTab:CreateSlider({
    Name = "WalkSpeed",
    Range = {16, 100},
    Increment = 0.5,
    Suffix = "Speed",
    CurrentValue = 16,
    Flag = "WalkSpeedSlider",
    Callback = function(Value)
        selectedSpeed = Value
    end,
})

MovementTab:CreateToggle({
    Name = "Enable WalkSpeed",
    CurrentValue = false,
    Flag = "WalkSpeedToggle",
    Callback = function(Value)
        walkspeedEnabled = Value
    end,
})

-- Visuals ESP
local espEnabled = false
local espColor = Color3.fromRGB(255,255,255)
local highlights = {}
local nametags = {}

local function removeESP(plr)
    local char = plr.Character
    if char then
        if highlights[char] then highlights[char]:Destroy() highlights[char] = nil end
        if nametags[char] then nametags[char]:Destroy() nametags[char] = nil end
    end
end

local function addESP(plr)
    local char = plr.Character
    if char and plr ~= player then
        -- Highlight
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESPHighlight"
        highlight.Adornee = char
        highlight.FillColor = espColor
        highlight.FillTransparency = 0.55
        highlight.OutlineColor = espColor
        highlight.OutlineTransparency = 0
        highlight.Parent = char
        highlights[char] = highlight

        -- Nametag
        local head = char:FindFirstChild("Head")
        if head then
            local billboard = Instance.new("BillboardGui")
            billboard.Name = "Nametag"
            billboard.Adornee = head
            billboard.Size = UDim2.new(0, 120, 0, 30)
            billboard.StudsOffset = Vector3.new(0, 2.25, 0) -- lowered for better view
            billboard.AlwaysOnTop = true

            local label = Instance.new("TextLabel")
            label.Size = UDim2.new(1,0,1,0)
            label.BackgroundTransparency = 1
            label.Text = plr.Name
            label.TextColor3 = espColor
            label.TextStrokeTransparency = 0
            label.TextScaled = true
            label.Parent = billboard

            billboard.Parent = workspace
            nametags[char] = billboard
        end
    end
end

VisualsTab:CreateToggle({
    Name = "Player ESP",
    CurrentValue = false,
    Flag = "PlayerESP",
    Callback = function(Value)
        espEnabled = Value
        for _, plr in pairs(Players:GetPlayers()) do
            if Value then
                addESP(plr)
            else
                removeESP(plr)
            end
        end
    end
})

VisualsTab:CreateColorPicker({
    Name = "ESP Color",
    CurrentColor = espColor,
    Flag = "ESPColor",
    Callback = function(Color)
        espColor = Color
        for _, h in pairs(highlights) do
            h.FillColor = Color
            h.OutlineColor = Color
        end
        for _, billboard in pairs(nametags) do
            local label = billboard:FindFirstChildOfClass("TextLabel")
            if label then label.TextColor3 = Color end
        end
    end
})

-- Refresh ESP on respawn
Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function()
        if espEnabled then addESP(plr) end
    end)
end)

Players.PlayerRemoving:Connect(function(plr)
    removeESP(plr)
end)

for _, plr in pairs(Players:GetPlayers()) do
    plr.CharacterAdded:Connect(function()
        if espEnabled then addESP(plr) end
    end)
end

Rayfield:LoadConfiguration()
