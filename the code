local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "Universal Utility",
    LoadingTitle = "Educational Purposes Only ;)",
    LoadingSubtitle = "Like and subscribe",
    ConfigurationSaving = {
        Enabled = false,
        FolderName = "MyGame",
        FileName = "Configuration"
    },
    KeySystem = false,
})

local MovementTab = Window:CreateTab("Movement", 4483362458)

local player = game.Players.LocalPlayer
local humanoid = player.Character and player.Character:FindFirstChildOfClass("Humanoid")

local isEnabled = false
local currentSpeed = 16
local speedConnection = nil

local noclipEnabled = false
local noclipConnection = nil

local flyEnabled = false
local flyConnection = nil
local flyBodyVelocity = nil
local flyBodyGyro = nil
local flySpeed = 50

local fullbrightEnabled = false
local fullbrightConnection = nil
local espEnabled = false
local espConnection = nil
local espColor = Color3.fromRGB(255, 255, 255)

local lighting = game:GetService("Lighting")
local storedLighting = {}

local function updateWalkspeed()
    local char = player.Character
    if char then
        local h = char:FindFirstChildOfClass("Humanoid")
        if h then
            h.WalkSpeed = currentSpeed
            humanoid = h
        end
    end
end

local function updateNoclip()
    if player.Character then
        for _, part in pairs(player.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end
end

local function updateFly()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local rootPart = player.Character.HumanoidRootPart
        
        if not flyBodyVelocity then
            flyBodyVelocity = Instance.new("BodyVelocity")
            flyBodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
            flyBodyVelocity.Parent = rootPart
        end
        
        if not flyBodyGyro then
            flyBodyGyro = Instance.new("BodyGyro")
            flyBodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            flyBodyGyro.P = 10000
            flyBodyGyro.Parent = rootPart
        end
        
        local camera = workspace.CurrentCamera
        flyBodyGyro.CFrame = camera.CFrame
        
        local userInputService = game:GetService("UserInputService")
        local moveDirection = Vector3.new(0, 0, 0)
        
        if userInputService:IsKeyDown(Enum.KeyCode.W) then
            moveDirection = moveDirection + camera.CFrame.LookVector
        end
        if userInputService:IsKeyDown(Enum.KeyCode.S) then
            moveDirection = moveDirection - camera.CFrame.LookVector
        end
        
        if userInputService:IsKeyDown(Enum.KeyCode.A) then
            moveDirection = moveDirection - camera.CFrame.RightVector
        end
        if userInputService:IsKeyDown(Enum.KeyCode.D) then
            moveDirection = moveDirection + camera.CFrame.RightVector
        end
        
        if userInputService:IsKeyDown(Enum.KeyCode.Space) then
            moveDirection = moveDirection + Vector3.new(0, 1, 0)
        end
        if userInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            moveDirection = moveDirection - Vector3.new(0, 1, 0)
        end
        
        if moveDirection.Magnitude > 0 then
            flyBodyVelocity.Velocity = moveDirection.Unit * flySpeed
        else
            flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
    end
end

local function updateFullbright()
    storedLighting.GlobalShadows = lighting.GlobalShadows
    storedLighting.Brightness = lighting.Brightness
    storedLighting.Ambient = lighting.Ambient
    storedLighting.OutdoorAmbient = lighting.OutdoorAmbient
    storedLighting.FogEnd = lighting.FogEnd
    storedLighting.FogStart = lighting.FogStart
    
    lighting.GlobalShadows = false
    lighting.Brightness = 1
    lighting.Ambient = Color3.fromRGB(64, 64, 64)
    lighting.OutdoorAmbient = Color3.fromRGB(127, 127, 127)
    lighting.FogEnd = math.huge
    lighting.FogStart = 0
    if lighting:FindFirstChild("Atmosphere") then
        lighting.Atmosphere:Destroy()
    end
end

local function resetFullbright()
    lighting.GlobalShadows = storedLighting.GlobalShadows
    lighting.Brightness = storedLighting.Brightness
    lighting.Ambient = storedLighting.Ambient
    lighting.OutdoorAmbient = storedLighting.OutdoorAmbient
    lighting.FogEnd = storedLighting.FogEnd
    lighting.FogStart = storedLighting.FogStart
end

local function isCharacterInvisible(character)
    if not character then return false end
    local parts = character:GetDescendants()
    local totalParts = 0
    local transparentParts = 0
    for _, part in pairs(parts) do
        if part:IsA("BasePart") then
            totalParts = totalParts + 1
            if part.Transparency >= 0.8 then
                transparentParts = transparentParts + 1
            end
        end
    end
    return totalParts > 0 and transparentParts >= totalParts * 0.5
end

local function updateESP()
    for _, otherPlayer in pairs(game.Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            local character = otherPlayer.Character
            local highlight = character:FindFirstChild("ESPHighlight")
            if not highlight then
                local success, newHighlight = pcall(Instance.new, "Highlight")
                if success then
                    highlight = newHighlight
                    highlight.Name = "ESPHighlight"
                    highlight.Parent = character
                else
                    continue
                end
            end
            if highlight then
                pcall(function()
                    local invisible = isCharacterInvisible(character)
                    highlight.FillColor = espColor
                    highlight.OutlineColor = espColor
                    highlight.OutlineTransparency = 0
                    if invisible then
                        highlight.FillTransparency = 0.5
                        highlight.OutlineThickness = 4
                    else
                        highlight.FillTransparency = 0.75
                        highlight.OutlineThickness = 3
                    end
                    highlight.Enabled = true
                end)
            end
        end
    end
end

local function removeESP()
    for _, otherPlayer in pairs(game.Players:GetPlayers()) do
        if otherPlayer.Character then
            pcall(function()
                local highlight = otherPlayer.Character:FindFirstChild("ESPHighlight")
                if highlight then
                    highlight:Destroy()
                end
            end)
        end
    end
end

local function onCharacterAdded(character)
    humanoid = character:WaitForChild("Humanoid")
    if isEnabled then
        updateWalkspeed()
    end
    if noclipEnabled then
        updateNoclip()
    end
    if flyEnabled then
        flyBodyVelocity = nil
        flyBodyGyro = nil
    end
    if espEnabled then
        task.wait(0.5)
        updateESP()
    end
end
player.CharacterAdded:Connect(onCharacterAdded)

local WalkspeedSlider = MovementTab:CreateSlider({
    Name = "Walkspeed Value",
    Range = {16, 200},
    Increment = 1,
    Suffix = " Speed",
    CurrentValue = 16,
    Flag = "WalkspeedSlider",
    Callback = function(Value)
        currentSpeed = Value
        if isEnabled then
            updateWalkspeed()
        end
    end,
})

local WalkspeedToggle = MovementTab:CreateToggle({
    Name = "Enable Walkspeed",
    CurrentValue = false,
    Flag = "WalkspeedToggle",
    Callback = function(Value)
        isEnabled = Value
        if isEnabled then
            speedConnection = game:GetService("RunService").Heartbeat:Connect(updateWalkspeed)
            updateWalkspeed()
        else
            if speedConnection then
                speedConnection:Disconnect()
                speedConnection = nil
            end
            if humanoid then
                humanoid.WalkSpeed = 16
            end
        end
    end,
})

local NoclipToggle = MovementTab:CreateToggle({
    Name = "Noclip",
    CurrentValue = false,
    Flag = "NoclipToggle",
    Callback = function(Value)
        noclipEnabled = Value
        if noclipEnabled then
            noclipConnection = game:GetService("RunService").Heartbeat:Connect(updateNoclip)
            updateNoclip()
        else
            if noclipConnection then
                noclipConnection:Disconnect()
                noclipConnection = nil
            end
            if player.Character then
                pcall(function()
                    for _, part in pairs(player.Character:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = true
                        end
                    end
                end)
            end
        end
    end,
})

local FlySpeedSlider = MovementTab:CreateSlider({
    Name = "Fly Speed",
    Range = {16, 200},
    Increment = 1,
    Suffix = " Speed",
    CurrentValue = 50,
    Flag = "FlySpeedSlider",
    Callback = function(Value)
        flySpeed = Value
    end,
})

local FlyToggle = MovementTab:CreateToggle({
    Name = "Fly",
    CurrentValue = false,
    Flag = "FlyToggle",
    Callback = function(Value)
        flyEnabled = Value
        if flyEnabled then
            flyConnection = game:GetService("RunService").Heartbeat:Connect(updateFly)
            updateFly()
        else
            if flyConnection then
                flyConnection:Disconnect()
                flyConnection = nil
            end
            if flyBodyVelocity then
                flyBodyVelocity:Destroy()
                flyBodyVelocity = nil
            end
            if flyBodyGyro then
                flyBodyGyro:Destroy()
                flyBodyGyro = nil
            end
        end
    end,
})

local VisualsTab = Window:CreateTab("Visuals", 4483362458)

local FullbrightToggle = VisualsTab:CreateToggle({
    Name = "Fullbright",
    CurrentValue = false,
    Flag = "FullbrightToggle",
    Callback = function(Value)
        fullbrightEnabled = Value
        if fullbrightEnabled then
            fullbrightConnection = game:GetService("RunService").Heartbeat:Connect(updateFullbright)
            updateFullbright()
        else
            if fullbrightConnection then
                fullbrightConnection:Disconnect()
                fullbrightConnection = nil
            end
            resetFullbright()
        end
    end,
})

local ESPToggle = VisualsTab:CreateToggle({
    Name = "Player ESP",
    CurrentValue = false,
    Flag = "ESPToggle",
    Callback = function(Value)
        espEnabled = Value
        if espEnabled then
            espConnection = game:GetService("RunService").Heartbeat:Connect(updateESP)
            updateESP()
        else
            if espConnection then
                espConnection:Disconnect()
                espConnection = nil
            end
            removeESP()
        end
    end,
})

local ESPColorPicker = VisualsTab:CreateColorPicker({
    Name = "ESP Color",
    Color = espColor,
    Flag = "ESPColor",
    Callback = function(Value)
        espColor = Value
        if espEnabled then
            updateESP()
        end
    end,
})
